<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Gestión Universitaria</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2em;
            background: #f4f6f8;
        }

        .hidden {
            display: none;
        }

        .admin {
            color: rgb(109, 186, 189);
        }

        table {
            border-collapse: collapse;
            margin-top: 1em;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px #0001;
        }

        th,
        td {
            border: 1px solid #bd8c8c;
            padding: 0.5em;
        }

        input[type="text"],
        input[type="number"],
        input[type="password"],
        input[type="email"] {
            width: 150px;
            padding: 0.5em;
            border-radius: 5px;
            border: 1px solid #b2bec3;
            margin-bottom: 0.5em;
        }

        .actions button,
        button,
        input[type="submit"] {
            margin-right: 0.5em;
            background: #1abc9c;
            color: #fff;
            font-weight: 600;
            padding: 0.6em 1.2em;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.2s;
        }

        .actions button:hover,
        button:hover,
        input[type="submit"]:hover {
            background: #159c85;
        }

        /* Login box style inspired by reference */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 70vh;
        }

        .login-box {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 12px #0002;
            padding: 2.5em 2em;
            min-width: 320px;
            max-width: 350px;
        }

        .login-box h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 1.5em;
            font-weight: 600;
        }

        .login-box label {
            display: block;
            font-weight: 500;
            color: #444;
            margin-bottom: 0.3em;
        }

        .login-box input[type="text"],
        .login-box input[type="password"] {
            width: 100%;
            padding: 0.7em 0.9em;
            border: 1px solid #b2bec3;
            border-radius: 5px;
            font-size: 1em;
            margin-bottom: 1.2em;
        }

        .login-box button {
            width: 100%;
            background: #1abc9c;
            color: #fff;
            font-weight: 600;
            padding: 0.8em 0;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.2s;
        }

        .login-box button:hover {
            background: #159c85;
        }

        .login-box .error {
            color: #e74c3c;
            text-align: center;
            margin-top: 1em;
        }

        /* Section containers */
        .section-container {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 12px #0001;
            padding: 2em;
            margin-bottom: 2em;
        }

        /* Responsive */
        @media (max-width: 600px) {

            .login-box,
            .section-container {
                min-width: unset;
                max-width: 100%;
                padding: 1em;
            }

            table {
                font-size: 0.95em;
            }
        }
    </style>
</head>

<body>

    <!-- Título principal de la aplicación -->
    <h1 style="text-align:center; color:#2c3e50;">Gestión Universitaria</h1>

    <!-- Sección de inicio de sesión -->
    <div id="login-section">
        <div class="login-container">
            <div class="login-box">
                <h2>Iniciar Sesión</h2>
                <form id="login-form">
                    <label>Usuario</label>
                    <input type="text" id="login-usuario" required autocomplete="username">
                    <label>Contraseña</label>
                    <input type="password" id="login-password" required autocomplete="current-password">
                    <button type="submit">Ingresar</button>
                </form>
                <div id="login-error" class="error"></div>
            </div>
        </div>
    </div>

    <!-- Sección principal de la aplicación (paneles, formularios y tablas) -->
    <div id="main-section" class="hidden">
        <!-- Panel de administración (solo visible para admin) -->
        <div id="admin-panel" class="hidden section-container" style="margin-bottom:1em;">
            <h2 class="admin">Panel de Administrador</h2>
            <button onclick="cerrarSesion()">Cerrar sesión</button>
        </div>
        <!-- Panel de usuario normal -->
        <div id="user-panel" class="hidden section-container" style="margin-bottom:1em;">
            <h2>Panel de Usuario</h2>
            <button onclick="cerrarSesion()">Cerrar sesión</button>
        </div>

        <!-- Formulario para registrar información de estudiante y materia -->
        <div class="section-container">
            <h3>Registro de Información Estudiante</h3>
            <form id="materia-form">
                <label>Nombres del estudiante:
                    <input type="text" id="info-nombres-est" required>
                </label>
                <label>Apellidos:
                    <input type="text" id="info-apellidos-est" required>
                </label>
                <label>Correo:
                    <input type="email" id="materia-correoestudiante" required>
                </label>
                <label>Celular:
                    <input type="text" id="materia-celular" required pattern="[0-9]{7,15}"
                        title="Solo números, mínimo 7 dígitos">
                </label>
                <label>Código de estudiante:
                    <input type="text" id="materia-codestudiante" required>
                </label>
                <label>Materia a registrar:
                    <input type="text" id="materia-nombre" required>
                </label>
                <label>Créditos:
                    <input type="number" id="materia-creditos" min="1" max="10" required>
                </label>
                <label>Código de materia:
                    <input type="text" id="materia-codigo" required>
                </label>
                <button type="submit">Registrar</button>
            </form>
            <div id="materia-error" style="color:#e74c3c;"></div>
        </div>

        <!-- Tabla de materias registradas -->
        <div class="section-container">
            <h3>Materias Registradas</h3>
            <table id="materias-table">
                <thead>
                    <tr>
                        <th>Nombres</th>
                        <th>Apellidos</th>
                        <th>Correo</th>
                        <th>Celular</th>
                        <th>Código Estudiante</th>
                        <th>Materia</th>
                        <th>Créditos</th>
                        <th>Código Materia</th>
                        <th>Notas Corte 1</th>
                        <th>Notas Corte 2</th>
                        <th>Notas Corte 3</th>
                        <th>Promedio</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Materias se insertan aquí -->
                </tbody>
            </table>
        </div>

        <!-- Formulario para modificar información personal (solo frontend) -->
        <div class="section-container">
            <h3>Modificar Información Personal</h3>
            <form id="info-form">
                <label>Nombres: <input type="text" id="info-nombres" required></label>
                <label>Apellidos: <input type="text" id="info-apellidos" required></label>
                <button type="submit">Actualizar</button>
            </form>
            <div id="info-error" style="color:#e74c3c;"></div>
        </div>

        <!-- Tabla de gestión de notas (solo visible para admin) -->
        <div id="admin-notas-section" class="section-container hidden">
            <h3>Gestión de Notas (Solo Administrador)</h3>
            <table id="admin-notas-table">
                <thead>
                    <tr>
                        <th>Materia</th>
                        <th>Código Materia</th>
                        <th>Estudiante</th>
                        <th>Corte 1</th>
                        <th>Corte 2</th>
                        <th>Corte 3</th>
                        <th>Promedio</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Filas generadas por JS -->
                </tbody>
            </table>
        </div>

        <!-- Formulario para modificar notas de un estudiante en tiempo real (solo admin) -->
        <div id="admin-modificar-notas" class="section-container hidden">
            <h3>Modificar Notas de Estudiante (Solo Administrador)</h3>
            <form id="form-modificar-notas">
                <label>Código de materia:
                    <input type="text" id="modificar-codigo-materia" required>
                </label>
                <button type="submit">Buscar</button>
            </form>
            <div id="modificar-notas-error" style="color:#e74c3c;"></div>
            <div id="modificar-notas-formulario" style="margin-top:1em;"></div>
        </div>
    </div>

    <!--
        Script principal de la aplicación web
        - Maneja login, paneles, formularios y comunicación con el backend
        - Actualiza la interfaz en tiempo real
    -->
    <script>
        // Variables globales para el estado de la sesión y datos
        let usuarioActual = null;
        let esAdmin = false;
        let materias = [];
        let notas = {}; // {codigoMateria: [corte1, corte2, corte3]}

        // Credenciales de ejemplo (solo para login local, no seguras)
        const usuarios = [
            { usuario: "admin", password: "admin123", admin: true, nombres: "Admin", apellidos: "Principal", correo: "admin@correo.com" },
            { usuario: "estudiante", password: "1234", admin: false, nombres: "Juan", apellidos: "Pérez", correo: "juan@correo.com" }
        ];

        // Muestra u oculta la sección de modificar notas según el rol
        function mostrarAdminModificarNotas() {
            document.getElementById('admin-modificar-notas').classList.toggle('hidden', !esAdmin);
        }

        // Maneja el login y muestra los paneles correspondientes
        document.getElementById('login-form').onsubmit = function (e) {
            e.preventDefault();
            const usuario = document.getElementById('login-usuario').value.trim();
            const password = document.getElementById('login-password').value;
            const user = usuarios.find(u => u.usuario === usuario && u.password === password);
            if (user) {
                usuarioActual = user;
                esAdmin = user.admin;
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('main-section').classList.remove('hidden');
                document.getElementById('admin-panel').classList.toggle('hidden', !esAdmin);
                document.getElementById('user-panel').classList.toggle('hidden', esAdmin);
                document.getElementById('info-nombres').value = user.nombres;
                document.getElementById('info-apellidos').value = user.apellidos;
                document.getElementById('admin-notas-section').classList.toggle('hidden', !esAdmin);
                mostrarAdminModificarNotas();
                cargarMaterias();
            } else {
                document.getElementById('login-error').textContent = "Usuario o contraseña incorrectos";
            }
        };

        // Cierra la sesión y oculta paneles
        function cerrarSesion() {
            usuarioActual = null;
            esAdmin = false;
            document.getElementById('main-section').classList.add('hidden');
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('login-form').reset();
            document.getElementById('login-error').textContent = "";
            document.getElementById('admin-notas-section').classList.add('hidden');
            document.getElementById('admin-modificar-notas').classList.add('hidden');
        }

        // Carga las materias desde el backend y actualiza la interfaz
        async function cargarMaterias() {
            const resp = await fetch('http://localhost:8080/api/materias');
            materias = await resp.json();
            notas = {};
            materias.forEach(m => notas[m.codigo] = m.notas || [null, null, null]);
            renderMaterias();
            if (esAdmin) renderAdminNotas();
        }

        // Refresca la tabla de materias cada 3 segundos para reflejar cambios en tiempo real
        setInterval(() => {
            if (document.getElementById('main-section') && !document.getElementById('main-section').classList.contains('hidden')) {
                cargarMaterias();
            }
        }, 3000);

        // Renderiza la tabla de notas para el panel de admin
        function renderAdminNotas() {
            const tbody = document.getElementById('admin-notas-table').querySelector('tbody');
            tbody.innerHTML = "";
            materias.forEach((mat, idx) => {
                const n = notas[mat.codigo] || [null, null, null];
                const promedio = calcularPromedio(n);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${mat.nombre}</td>
                    <td>${mat.codigo}</td>
                    <td>${mat.nombresEst} ${mat.apellidosEst}</td>
                    <td><input type="number" min="0" max="5" step="0.01" value="${n[0] ?? ''}" onchange="adminActualizarNota('${mat.codigo}',0,this.value)"></td>
                    <td><input type="number" min="0" max="5" step="0.01" value="${n[1] ?? ''}" onchange="adminActualizarNota('${mat.codigo}',1,this.value)"></td>
                    <td><input type="number" min="0" max="5" step="0.01" value="${n[2] ?? ''}" onchange="adminActualizarNota('${mat.codigo}',2,this.value)"></td>
                    <td>${promedio}</td>
                    <td>
                        <button onclick="adminLimpiarNotas('${mat.codigo}')">Limpiar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Permite al admin actualizar las notas de una materia
        window.adminActualizarNota = async function (codigo, corte, valor) {
            let nota = parseFloat(valor);
            if (isNaN(nota) || nota < 0 || nota > 5) {
                alert("Nota inválida. Debe estar entre 0 y 5.");
                renderAdminNotas();
                return;
            }
            notas[codigo][corte] = nota;
            await fetch(`http://localhost:8080/api/materias/${codigo}/notas`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(notas[codigo])
            });
            cargarMaterias();
        };

        // Permite al admin limpiar las notas de una materia
        window.adminLimpiarNotas = async function (codigo) {
            notas[codigo] = [null, null, null];
            await fetch(`http://localhost:8080/api/materias/${codigo}/notas`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(notas[codigo])
            });
            cargarMaterias();
        };

        // Formulario para buscar y modificar notas de una materia (solo admin)
        document.getElementById('form-modificar-notas').onsubmit = function (e) {
            e.preventDefault();
            const codigo = document.getElementById('modificar-codigo-materia').value.trim();
            const materia = materias.find(m => m.codigo === codigo);
            const notasMateria = notas[codigo];
            const contenedor = document.getElementById('modificar-notas-formulario');
            if (!materia) {
                document.getElementById('modificar-notas-error').textContent = "No se encontró la materia con ese código.";
                contenedor.innerHTML = "";
                return;
            }
            document.getElementById('modificar-notas-error').textContent = "";
            contenedor.innerHTML = `
                <div style="margin-bottom:1em;">
                    <strong>Materia:</strong> ${materia.nombre}<br>
                    <strong>Estudiante:</strong> ${materia.nombresEst} ${materia.apellidosEst}
                </div>
                <form id="form-editar-notas">
                    <label>Nota Corte 1:
                        <input type="number" min="0" max="5" step="0.01" id="nota-corte-1" value="${notasMateria[0] ?? ''}" required>
                    </label>
                    <label>Nota Corte 2:
                        <input type="number" min="0" max="5" step="0.01" id="nota-corte-2" value="${notasMateria[1] ?? ''}" required>
                    </label>
                    <label>Nota Corte 3:
                        <input type="number" min="0" max="5" step="0.01" id="nota-corte-3" value="${notasMateria[2] ?? ''}" required>
                    </label>
                    <button type="submit">Guardar Cambios</button>
                </form>
                <div id="modificar-notas-resultado" style="margin-top:1em;color:green;"></div>
                <div><strong>Promedio actual:</strong> <span id="promedio-actual">${calcularPromedio(notasMateria)}</span></div>
            `;
            document.getElementById('form-editar-notas').onsubmit = async function (ev) {
                ev.preventDefault();
                const n1 = parseFloat(document.getElementById('nota-corte-1').value);
                const n2 = parseFloat(document.getElementById('nota-corte-2').value);
                const n3 = parseFloat(document.getElementById('nota-corte-3').value);
                if ([n1, n2, n3].some(n => isNaN(n) || n < 0 || n > 5)) {
                    document.getElementById('modificar-notas-resultado').style.color = "red";
                    document.getElementById('modificar-notas-resultado').textContent = "Las notas deben estar entre 0 y 5.";
                    return;
                }
                notas[codigo] = [n1, n2, n3];
                await fetch(`http://localhost:8080/api/materias/${codigo}/notas`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(notas[codigo])
                });
                document.getElementById('modificar-notas-resultado').style.color = "green";
                document.getElementById('modificar-notas-resultado').textContent = "Notas actualizadas correctamente.";
                document.getElementById('promedio-actual').textContent = calcularPromedio(notas[codigo]);
                cargarMaterias();
            };
        };

        // Maneja el registro de estudiante y materia desde el formulario principal
        document.getElementById('materia-form').onsubmit = async function (e) {
            e.preventDefault();
            const nombresEst = document.getElementById('info-nombres-est').value.trim();
            const apellidosEst = document.getElementById('info-apellidos-est').value.trim();
            const correoEstudiante = document.getElementById('materia-correoestudiante').value.trim();
            const celular = document.getElementById('materia-celular').value.trim();
            const codEstudiante = document.getElementById('materia-codestudiante').value.trim();
            const nombre = document.getElementById('materia-nombre').value.trim();
            const creditos = parseInt(document.getElementById('materia-creditos').value, 10);
            const codigo = document.getElementById('materia-codigo').value.trim();

            if (!nombresEst || !apellidosEst || !correoEstudiante || !celular || !codEstudiante || !nombre || !codigo || isNaN(creditos) || creditos < 1 || creditos > 10) {
                document.getElementById('materia-error').textContent = "Todos los campos son obligatorios y deben ser válidos.";
                return;
            }
            // Guardar estudiante (opcional, si quieres tenerlo en la tabla de estudiantes)
            await fetch('http://localhost:8080/api/estudiantes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    codigo: codEstudiante,
                    nombres: nombresEst,
                    apellidos: apellidosEst,
                    correo: correoEstudiante,
                    celular: celular
                })
            });
            // Guardar materia
            const resp = await fetch('http://localhost:8080/api/materias', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    nombre,
                    codigo,
                    creditos,
                    codigoEstudiante: codEstudiante,
                    nombresEst,
                    apellidosEst,
                    correoEstudiante,
                    celular,
                    notas: [null, null, null]
                })
            });
            if (resp.ok) {
                document.getElementById('materia-form').reset();
                document.getElementById('materia-error').textContent = "";
                cargarMaterias();
            } else {
                document.getElementById('materia-error').textContent = "Error al registrar materia";
            }
        };

        // Permite modificar la información personal del usuario (solo frontend)
        document.getElementById('info-form').onsubmit = function (e) {
            e.preventDefault();
            const nombres = document.getElementById('info-nombres').value.trim();
            const apellidos = document.getElementById('info-apellidos').value.trim();
            if (!nombres || !apellidos) {
                document.getElementById('info-error').textContent = "Nombres y apellidos no pueden estar vacíos.";
                return;
            }
            usuarioActual.nombres = nombres;
            usuarioActual.apellidos = apellidos;
            document.getElementById('info-error').textContent = "Información actualizada correctamente.";
        };

        // Renderiza la tabla de materias y notas para todos los usuarios
        function renderMaterias() {
            const tbody = document.getElementById('materias-table').querySelector('tbody');
            tbody.innerHTML = "";
            materias.forEach((mat, idx) => {
                const n = notas[mat.codigo] || [null, null, null];
                const disabled = esAdmin ? '' : 'disabled';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${mat.nombresEst || ''}</td>
                    <td>${mat.apellidosEst || ''}</td>
                    <td>${mat.correoEstudiante || ''}</td>
                    <td>${mat.celular || ''}</td>
                    <td>${mat.codigoEstudiante || ''}</td>
                    <td>${mat.nombre}</td>
                    <td>${mat.creditos}</td>
                    <td>${mat.codigo}</td>
                    <td><input type="number" min="0" max="5" step="0.01" value="${n[0] ?? ''}" onchange="actualizarNota('${mat.codigo}',0,this.value)" ${disabled}></td>
                    <td><input type="number" min="0" max="5" step="0.01" value="${n[1] ?? ''}" onchange="actualizarNota('${mat.codigo}',1,this.value)" ${disabled}></td>
                    <td><input type="number" min="0" max="5" step="0.01" value="${n[2] ?? ''}" onchange="actualizarNota('${mat.codigo}',2,this.value)" ${disabled}></td>
                    <td>${calcularPromedio(n)}</td>
                    <td class="actions">
                        ${esAdmin ? `<button onclick="eliminarMateria('${mat.codigo}')">Eliminar</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Permite al admin actualizar una nota desde la tabla principal
        window.actualizarNota = async function (codigo, corte, valor) {
            if (!esAdmin) return;
            let nota = parseFloat(valor);
            if (isNaN(nota) || nota < 0 || nota > 5) {
                alert("Nota inválida. Debe estar entre 0 y 5.");
                renderMaterias();
                return;
            }
            notas[codigo][corte] = nota;
            await fetch(`http://localhost:8080/api/materias/${codigo}/notas`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(notas[codigo])
            });
            cargarMaterias();
        };

        // Calcula el promedio de las notas de una materia
        function calcularPromedio(notasArr) {
            let sum = 0, count = 0;
            notasArr.forEach(n => {
                if (typeof n === "number" && n !== null) {
                    sum += n;
                    count++;
                }
            });
            return count === 0 ? "" : (sum / count).toFixed(2);
        }

        // Permite al admin eliminar una materia
        window.eliminarMateria = async function (codigo) {
            if (!esAdmin) return;
            await fetch(`http://localhost:8080/api/materias/${codigo}`, { method: 'DELETE' });
            cargarMaterias();
        };
    </script>
</body>

</html>